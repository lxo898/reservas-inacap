{% extends "base.html" %}
{% block title %}Mi historial{% endblock %}
{% block content %}

<section class="p-4 rounded-4 mb-4 inacap-hero">
  <h1 class="h3 m-0">ðŸ“œ Mi historial de reservas</h1>
</section>

<div class="card shadow-sm border-0 rounded-4">
  <div class="card-body">
    {% if reservations %}
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Espacio</th>
              <th>Inicio</th>
              <th>TÃ©rmino</th>
              <th>Estado</th>
              <th>Notas administraciÃ³n</th>
              <th>PropÃ³sito</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for r in reservations %}
              <tr id="r{{ r.id }}">
                <td class="fw-semibold">{{ r.space }}</td>
                <td><span class="small text-muted">{{ r.start|date:"Y-m-d H:i" }}</span></td>
                <td><span class="small text-muted">{{ r.end|date:"Y-m-d H:i" }}</span></td>
                <td>
                  {% if r.status == "PEND" %}
                    <span class="badge rounded-pill text-bg-warning">Pendiente</span>
                  {% elif r.status == "APPR" %}
                    <span class="badge rounded-pill text-bg-success">Aprobada</span>
                  {% elif r.status == "REJ" %}
                    <span class="badge rounded-pill text-bg-danger">Rechazada</span>
                  {% elif r.status == "CANC" %}
                    <span class="badge rounded-pill text-bg-secondary">Cancelada</span>
                  {% else %}
                    <span class="badge text-bg-secondary">{{ r.get_status_display }}</span>
                  {% endif %}
                </td>

                <td>
                  {% if r.appr %}
                    <span class="small text-muted">{{ r.appr.notes|default:"â€”"|truncatechars:80 }}</span>
                  {% else %}
                    <span class="text-muted small">â€”</span>
                  {% endif %}
                </td>

                <td>{{ r.purpose|default:"â€”" }}</td>

                <td class="text-end">
                  <a href="{% url 'reservation_detail' r.id %}" class="btn btn-outline-primary btn-sm me-1">
                    <i class="bi bi-search"></i> Ver
                  </a>

                  {% if r.can_cancel %}
                    <button class="btn btn-outline-danger btn-sm"
                            data-bs-toggle="modal" data-bs-target="#cancelModal{{ r.id }}">
                      <i class="bi bi-x-circle"></i> Cancelar
                    </button>

                    <!-- Modal de confirmaciÃ³n -->
                    <div class="modal fade" id="cancelModal{{ r.id }}" tabindex="-1" aria-hidden="true">
                      <div class="modal-dialog">
                        <form method="post" action="{% url 'reservation_cancel' r.id %}" class="modal-content">
                          {% csrf_token %}
                          <div class="modal-header">
                            <h5 class="modal-title">Cancelar reserva</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                          </div>
                          <div class="modal-body">
                            <p class="mb-3">Â¿Seguro que deseas cancelar la reserva de <strong>{{ r.space }}</strong> del
                              <strong>{{ r.start|date:"d/m/Y H:i" }}</strong> al <strong>{{ r.end|date:"d/m/Y H:i" }}</strong>?</p>
                            <label class="form-label small">Motivo (opcional)</label>
                            <input type="text" name="reason" maxlength="255" class="form-control"
                                   placeholder="Ej.: cambio de horario">
                            <div class="alert alert-warning small mt-3 mb-0">
                              Esta acciÃ³n no se puede deshacer.
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Volver</button>
                            <button type="submit" class="btn btn-danger">
                              <i class="bi bi-x-circle"></i> Cancelar reserva
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  {% else %}
                    <span class="text-muted small">â€”</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info m-0">AÃºn no tienes reservas.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
