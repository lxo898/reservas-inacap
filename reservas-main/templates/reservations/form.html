{% extends "base.html" %} {# Fixed syntax error v2 #}
{% block title %}{{ form.instance.pk|yesno:"Editar reserva,Nueva reserva" }}{% endblock %}

{% block content %}
<section class="p-4 rounded-4 mb-4 inacap-hero">
  <h1 class="h3 m-0">{{ form.instance.pk|yesno:"‚úèÔ∏è Editar reserva,üóìÔ∏è Nueva reserva" }}</h1>
</section>

<style>
  form input[type="text"],
  form input[type="datetime-local"],
  form textarea,
  form select {
    width: 100%;
    padding: .6rem .8rem;
    border: 1px solid #dee2e6;
    border-radius: .5rem;
    background: #fff;
  }

  #conflictAlert {
    display: none;
  }

  #calendar {
    min-height: 520px;
  }

  .legend-dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: .4rem;
  }
</style>

<div class="card shadow-sm border-0 rounded-4">
  <div class="card-body">
    <div id="conflictAlert" class="alert alert-danger rounded-3 mb-4">
      ‚ö†Ô∏è Existe un conflicto de horario con otra reserva para este espacio. Ajusta la fecha/bloques para continuar.
    </div>

    <form id="resForm" method="post" novalidate>
      {% csrf_token %}

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Espacio</label>
          {{ form.space }}
          {% if form.space.errors %}<div class="text-danger small">{{ form.space.errors }}</div>{% endif %}
        </div>

        <div class="col-md-3">
          <label class="form-label">Fecha</label>
          {{ form.date }}
          {% if form.date.errors %}<div class="text-danger small">{{ form.date.errors }}</div>{% endif %}
        </div>

        <div class="col-md-2">
          <label class="form-label">Desde</label>
          {{ form.start_slot }}
          {% if form.start_slot.errors %}<div class="text-danger small">{{ form.start_slot.errors }}</div>{% endif %}
        </div>

        <div class="col-md-2">
          <label class="form-label">Hasta</label>
          {{ form.end_slot }}
          {% if form.end_slot.errors %}<div class="text-danger small">{{ form.end_slot.errors }}</div>{% endif %}
        </div>

        <div class="col-md-2">
          <label class="form-label">Personas</label>
          {{ form.attendees_count }}
          {% if form.attendees_count.errors %}
          <div class="text-danger small">{{ form.attendees_count.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="mt-3 mb-4">
        <label class="form-label">Motivo / prop√≥sito</label>
        {{ form.purpose }}
        {% if form.purpose.errors %}<div class="text-danger small">{{ form.purpose.errors }}</div>{% endif %}
      </div>

      <!-- ========= Solicitud de recursos por el usuario ========= -->
      <div class="mt-3 mb-4">
        <label class="form-label d-flex align-items-center gap-2">
          Recursos necesarios <span class="text-muted small">(opcional)</span>
        </label>

        <select name="resources" id="resourcesSelect" class="form-select" multiple size="5">
          {% for res in resources_all %}
          <option value="{{ res.id }}">{{ res.name }}</option>
          {% empty %}
          <option disabled>No hay recursos disponibles</option>
          {% endfor %}
        </select>

        <label class="form-label mt-3">Detalle de recursos (cantidad, requisitos, etc.)</label>
        <textarea name="resources_notes" class="form-control" rows="2"
          placeholder="Ej: 2 proyectores, 1 notebook y 1 alargador de 5 mts."></textarea>
      </div>
      <!-- ======================================================= -->

      <a href="{% url 'dashboard_user' %}" class="btn btn-outline-secondary rounded-3">Cancelar</a>
      <button id="submitBtn" type="submit" class="btn btn-primary rounded-3">Guardar</button>
    </form>
  </div>
</div>

<div class="card shadow-sm border-0 rounded-4 mt-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h5 m-0">Disponibilidad</h2>
      <div class="small text-muted">
        <span class="legend-dot" style="background:#198754"></span> Aprobada
        &nbsp;&nbsp;
        <span class="legend-dot" style="background:#ffc107"></span> Pendiente
      </div>
    </div>
    <div id="calendar"></div>
  </div>
</div>

<!-- FullCalendar (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/locales-all.global.min.js"></script>

<script>
  (function () {
    const availabilityUrl = "{% url 'availability_json' %}";
    const form = document.getElementById('resForm');
    const spaceEl = form.querySelector('[name="space"]');
    const dateEl = form.querySelector('[name="date"]');
    const startSlotEl = form.querySelector('[name="start_slot"]');
    const endSlotEl = form.querySelector('[name="end_slot"]');
    const alertEl = document.getElementById('conflictAlert');
    const submitBtn = document.getElementById('submitBtn');

    let calendar;
    let eventsCache = [];

    function parseISODateTime(dStr, hmStr) {
      // dStr: "YYYY-MM-DD", hmStr: "HH:MM" ‚Üí Date
      if (!dStr || !hmStr) return null;
      const dtStr = dStr + 'T' + hmStr + ':00';
      const d = new Date(dtStr);
      return isNaN(d) ? null : d;
    }

    function overlaps(aStart, aEnd, bStart, bEnd) {
      return aStart < bEnd && aEnd > bStart;
    }

    async function loadEvents() {
      const space = spaceEl.value;
      if (!space) { eventsCache = []; renderCal([]); return; }
      const url = availabilityUrl + "?space=" + encodeURIComponent(space);
      const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
      eventsCache = res.ok ? await res.json() : [];
      renderCal(eventsCache);
      checkConflict();
    }

    function renderCal(events) {
      const el = document.getElementById('calendar');
      const isMobile = window.matchMedia('(max-width: 768px)').matches;

      if (!calendar) {
        calendar = new FullCalendar.Calendar(el, {
          locale: 'es',
          firstDay: 1,
          initialView: isMobile ? 'listWeek' : 'timeGridWeek',
          headerToolbar: isMobile
            ? { left: 'prev,next today', center: 'title', right: 'listWeek,dayGridMonth' }
            : { left: 'prev,next today', center: 'title', right: 'timeGridDay,timeGridWeek,dayGridMonth' },
          slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
          slotMinTime: '07:00:00',
          slotMaxTime: '22:00:00',
          nowIndicator: true,
          expandRows: true,
          height: 'auto',
          events: events.map(e => ({
            id: e.id,
            title: e.title,
            start: e.start,
            end: e.end,
            backgroundColor: e.backgroundColor,
            borderColor: e.borderColor,
            textColor: e.textColor,
          }))
        });
        calendar.render();
      } else {
        calendar.removeAllEvents();
        events.forEach(e => {
          calendar.addEvent({
            id: e.id,
            title: e.title,
            start: e.start,
            end: e.end,
            backgroundColor: e.backgroundColor,
            borderColor: e.borderColor,
            textColor: e.textColor,
          });
        });
      }
    }

    function checkConflict() {
      alertEl.style.display = 'none';
      submitBtn.disabled = false;

      const space = spaceEl.value;
      const d = dateEl.value;
      const sHM = startSlotEl.value;
      const eHM = endSlotEl.value;
      if (!space || !d || !sHM || !eHM) return;

      const s = parseISODateTime(d, sHM);
      const e = parseISODateTime(d, eHM);
      if (!s || !e) return;

      const conflict = eventsCache.some(ev => {
        const es = new Date(ev.start);
        const ee = new Date(ev.end);
        return overlaps(s, e, es, ee);
      });

      if (conflict) {
        alertEl.style.display = 'block';
        submitBtn.disabled = true;
      }
    }

    spaceEl?.addEventListener('change', loadEvents);
    dateEl?.addEventListener('change', checkConflict);
    startSlotEl?.addEventListener('change', checkConflict);
    endSlotEl?.addEventListener('change', checkConflict);

    loadEvents(); // inicial
  })();
</script>
{% endblock %}