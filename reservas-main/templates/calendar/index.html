{% extends "base.html" %}
{% block title %}Calendario de reservas · Reservas Inacap{% endblock %}

{% block content %}
<section class="p-4 rounded-4 mb-4 inacap-hero">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1 class="h3 m-0">Calendario de reservas</h1>
      <div class="small text-white-50">Vista mensual / semanal / diaria</div>
    </div>
    <div class="d-none d-md-flex align-items-center gap-2">
      <span class="badge rounded-pill bg-light text-dark"></span>
      <span class="badge rounded-pill bg-warning text-dark"></span>
    </div>
  </div>
</section>

<div class="card shadow-sm border-0 rounded-4">
  <div class="card-body">
    <div class="row g-3 align-items-end mb-3">
      <div class="col-12 col-md-6">
        <label class="form-label">Filtrar por espacio</label>
        <select id="spaceFilter" class="form-select">
          <option value="">Todos los espacios</option>
          {% for s in spaces %}
            <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-6 text-md-end">
        <div class="btn-group" role="group" aria-label="Cambiar vista">
          <button class="btn btn-outline-primary" data-view="dayGridMonth">Mes</button>
          <button class="btn btn-outline-primary" data-view="timeGridWeek">Semana</button>
          <button class="btn btn-outline-primary" data-view="timeGridDay">Día</button>
          <button class="btn btn-outline-primary" data-view="listWeek">Lista</button>
        </div>
      </div>
    </div>

    <div id="calendar"></div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/locales-all.global.min.js"></script>

{% block extra_js %}
<script>
(function(){
  const availabilityUrl = "{% url 'availability_json' %}";
  const el = document.getElementById('calendar');
  const spaceSel = document.getElementById('spaceFilter');
  const isMobile = window.matchMedia('(max-width: 768px)').matches;

  const calendar = new FullCalendar.Calendar(el, {
    locale: 'es',
    firstDay: 1,
    initialView: isMobile ? 'listWeek' : 'dayGridMonth',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
    },
    height: 'auto',
    expandRows: true,
    slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
    slotMinTime: '07:00:00',
    slotMaxTime: '22:00:00',
    nowIndicator: true,
    events: async function(info, successCallback, failureCallback){
      try {
        const params = new URLSearchParams();
        if (spaceSel.value) params.set('space', spaceSel.value);
        const url = availabilityUrl + (params.toString() ? ('?'+params.toString()) : '');
        const res = await fetch(url, {headers: {"X-Requested-With":"XMLHttpRequest"}});
        const data = res.ok ? await res.json() : [];
        successCallback(data);
      } catch (e) {
        console.error(e);
        failureCallback(e);
      }
    },
    eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
    eventDidMount: function(info){
      const title = info.event.title || '';
      const start = info.event.start;
      const end   = info.event.end;
      if (!start || !end) return;
      const fmt = (d) => d.toLocaleString(undefined, {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
      info.el.title = title + '\n' + fmt(start) + ' – ' + fmt(end);
      info.el.style.cursor = 'pointer';
    },
    eventClick: function(info){
      const id = info.event.id;
      if (id) window.location.href = "/reservas/" + id + "/";
    },
  });

  calendar.render();

  document.querySelectorAll('[data-view]').forEach(btn => {
    btn.addEventListener('click', () => calendar.changeView(btn.getAttribute('data-view')));
  });
  spaceSel.addEventListener('change', () => calendar.refetchEvents());
})();
</script>
{% endblock %}
{% endblock %}
